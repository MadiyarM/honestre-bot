import re
from telegram import (
    Update, ReplyKeyboardRemove, ReplyKeyboardMarkup
)
from telegram.ext import (
    ContextTypes, ConversationHandler,
    CommandHandler, MessageHandler, filters
)
import config
from db import save_review
from handlers.start import MAIN_MENU, start as cmd_start  # Ğ´Ğ»Ñ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚Ğ° Ğ² Ğ¼ĞµĞ½Ñ

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ĞšĞ¾Ğ½ÑÑ‚Ğ°Ğ½Ñ‚Ñ‹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ASKING, CONFIRM = range(2)

_CONFIRM_KB = ReplyKeyboardMarkup(
    [["Ğ”Ğ°", "ĞĞµÑ‚", "ĞĞ°Ğ·Ğ°Ğ´"]], resize_keyboard=True, one_time_keyboard=True
)

_VALID_CODES = {
    "700","701","702","703","704","705","706","707","708","709",
    "747","750","751","760","761","762","763","764",
    "771","775","776","777","778","727",
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Entry
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async def entry_start_review(update: Update, context: ContextTypes.DEFAULT_TYPE):
    context.user_data.clear()
    context.user_data["answers"] = {}
    context.user_data["q_idx"] = 0
    await _ask_next_question(update, context)
    return ASKING

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Helpers
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

def _build_markup(options: list[str] | None, allow_back: bool) -> ReplyKeyboardMarkup | None:
    rows: list[list[str]] = []
    if options:
        rows.append(options)
    if allow_back:
        rows.append(["ĞĞ°Ğ·Ğ°Ğ´"])
    return ReplyKeyboardMarkup(rows, resize_keyboard=True, one_time_keyboard=True) if rows else None

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Core ask/answer flow
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async def _ask_next_question(update: Update, context: ContextTypes.DEFAULT_TYPE):
    idx = context.user_data["q_idx"]

    # ----- Ğ²ÑĞµ Ğ²Ğ¾Ğ¿Ñ€Ğ¾ÑÑ‹ Ğ¿Ñ€Ğ¾Ğ¹Ğ´ĞµĞ½Ñ‹ -----
    if idx >= len(config.QUESTIONS):
        a = context.user_data["answers"]
        summary = "\n".join([
            f"ğŸ“± Ğ¢ĞµĞ»ĞµÑ„Ğ¾Ğ½: {a.get('phone')}",
            f"ğŸ™ï¸ Ğ“Ğ¾Ñ€Ğ¾Ğ´: {a.get('city')}",
            f"ğŸ˜ï¸ Ğ–Ğš: {a.get('complex_name')}",
            f"ğŸ‘¤ Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ: {a.get('status')}",
            f"ğŸ”¥ ĞÑ‚Ğ¾Ğ¿Ğ»ĞµĞ½Ğ¸Ğµ: {a.get('heating')}/5",
            f"âš¡ Ğ­Ğ»ĞµĞºÑ‚Ñ€Ğ¾: {a.get('electricity')}/5",
            f"ğŸ›¢ï¸ Ğ“Ğ°Ğ·: {a.get('gas')}/5",
            f"ğŸ’§ Ğ’Ğ¾Ğ´Ğ°: {a.get('water')}/5",
            f"ğŸ”Š Ğ¨ÑƒĞ¼: {a.get('noise')}/5",
            f"ğŸ¢ Ğ£Ğš: {a.get('mgmt')}/5",
            f"ğŸ’° ĞÑ€ĞµĞ½Ğ´Ğ°: {a.get('rent_price')}",
            f"ğŸ‘ ĞÑ€Ğ°Ğ²Ğ¸Ñ‚ÑÑ: {a.get('likes')}",
            f"ğŸ‘ Ğ Ğ°Ğ·Ğ´Ñ€Ğ°Ğ¶Ğ°ĞµÑ‚: {a.get('annoy')}",
            f"âœ… Ğ ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ°Ñ†Ğ¸Ñ: {'Ğ”Ğ°' if a.get('recommend') else 'ĞĞµÑ‚'}",
        ])
        await update.message.reply_text(summary + "\n\nĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´Ğ°ĞµÑ‚Ğµ Ğ¾Ñ‚Ğ·Ñ‹Ğ²?", reply_markup=_CONFIRM_KB)
        return CONFIRM

    # ----- Ğ·Ğ°Ğ´Ğ°Ñ‘Ğ¼ Ğ¾Ñ‡ĞµÑ€ĞµĞ´Ğ½Ğ¾Ğ¹ Ğ²Ğ¾Ğ¿Ñ€Ğ¾Ñ -----
    q = config.QUESTIONS[idx]
    allow_back = idx > 0
    markup = _build_markup(q.get("options") if q["type"] == "choice" else None, allow_back)
    await update.message.reply_text(q["text"], reply_markup=markup)
    return ASKING

async def _collect_answer(update: Update, context: ContextTypes.DEFAULT_TYPE):
    idx = context.user_data["q_idx"]
    q   = config.QUESTIONS[idx]
    text = (update.message.text or "").strip()

    # ------ ĞšĞ½Ğ¾Ğ¿ĞºĞ° Â«ĞĞ°Ğ·Ğ°Ğ´Â» ------
    if text.lower() == "Ğ½Ğ°Ğ·Ğ°Ğ´":
        if idx == 0:
            await update.message.reply_text("Ğ’Ñ‹ ÑƒĞ¶Ğµ Ğ½Ğ° Ğ¿ĞµÑ€Ğ²Ğ¾Ğ¼ Ğ²Ğ¾Ğ¿Ñ€Ğ¾ÑĞµ.")
            return ASKING
        context.user_data["q_idx"] -= 1
        return await _ask_next_question(update, context)

    # ------ ĞŸÑ€Ğ¸ Ğ¿ĞµÑ€Ğ²Ğ¾Ğ¼ Ğ²Ğ¾Ğ¿Ñ€Ğ¾ÑĞµ Ğ¸Ğ³Ğ½Ğ¾Ñ€Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ğ¾Ğµ Ğ½Ğ°Ğ¶Ğ°Ñ‚Ğ¸Ğµ ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ Ğ¼ĞµĞ½Ñ ------
    if q["key"] == "phone" and text in {"ğŸ“ ĞÑÑ‚Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¾Ñ‚Ğ·Ñ‹Ğ²", "ğŸ” ĞĞ°Ğ¹Ñ‚Ğ¸ Ğ–Ğš"}:
        await update.message.reply_text(q["text"])  # Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€ÑĞµĞ¼ Ğ²Ğ¾Ğ¿Ñ€Ğ¾Ñ Ğ¾ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğµ
        return ASKING

    # ------ Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ° ------
    if q["key"] == "phone":
        ok, err = _validate_phone(text)
        if not ok:
            await update.message.reply_text(err)
            return ASKING
        context.user_data["answers"][q["key"]] = text

    # ------ Ğ ĞµĞ¹Ñ‚Ğ¸Ğ½Ğ³ ------
    elif q["type"] == "rating":
        try:
            val = int(text)
            if not 1 <= val <= 5:
                raise ValueError
        except ValueError:
            await update.message.reply_text("Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ñ‡Ğ¸ÑĞ»Ğ¾ Ğ¾Ñ‚ 1 Ğ´Ğ¾ 5.")
            return ASKING
        context.user_data["answers"][q["key"]] = val

    # ------ Ğ’Ñ‹Ğ±Ğ¾Ñ€ Ğ¸Ğ· ÑĞ¿Ğ¸ÑĞºĞ° ------
    elif q["type"] == "choice":
        if text not in q["options"]:
            await update.message.reply_text("ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, Ğ²Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ²Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚ Ğ¸Ğ· ĞºĞ»Ğ°Ğ²Ğ¸Ğ°Ñ‚ÑƒÑ€Ñ‹.")
            return ASKING
        context.user_data["answers"][q["key"]] = text

    # ------ Ğ¢ĞµĞºÑÑ‚Ğ¾Ğ²Ñ‹Ğµ Ğ¾Ñ‚Ğ²ĞµÑ‚Ñ‹ ------
    else:
        context.user_data["answers"][q["key"]] = text

    context.user_data["q_idx"] += 1
    return await _ask_next_question(update, context)

    # ---- Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ° ----
    if q["key"] == "phone":
        ok, err = _validate_phone(text)
        if not ok:
            await update.message.reply_text(err)
            return ASKING
        context.user_data["answers"][q["key"]] = text

    # ---- Ğ ĞµĞ¹Ñ‚Ğ¸Ğ½Ğ³ ----
    elif q["type"] == "rating":
        try:
            val = int(text)
            if not 1 <= val <= 5:
                raise ValueError
        except ValueError:
            await update.message.reply_text("Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ñ‡Ğ¸ÑĞ»Ğ¾ Ğ¾Ñ‚ 1 Ğ´Ğ¾ 5.")
            return ASKING
        context.user_data["answers"][q["key"]] = val

    # ---- Choice ----
    elif q["type"] == "choice":
        if text not in q["options"]:
            await update.message.reply_text("ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, Ğ²Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ²Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚ Ğ¸Ğ· ĞºĞ»Ğ°Ğ²Ğ¸Ğ°Ñ‚ÑƒÑ€Ñ‹.")
            return ASKING
        context.user_data["answers"][q["key"]] = text

    # ---- Plain text ----
    else:
        context.user_data["answers"][q["key"]] = text

    context.user_data["q_idx"] += 1
    return await _ask_next_question(update, context)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Validation helpers
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

def _validate_phone(num: str) -> tuple[bool, str | None]:
    if num.startswith("+7") and len(num) == 12 and num[1:].isdigit():
        code = num[2:5]
    elif num.startswith("8") and len(num) == 11 and num.isdigit():
        code = num[1:4]
    else:
        return False, "â—ï¸ ĞĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚. Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ½Ğ¾Ğ¼ĞµÑ€ Ğ² Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğµ +7XXXXXXXXXX Ğ¸Ğ»Ğ¸ 8XXXXXXXXXX"
    if code not in _VALID_CODES:
        return False, "â—ï¸ ĞĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚. Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğ¹ Ğ½Ğ¾Ğ¼ĞµÑ€"
    return True, None

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Confirm step
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async def _confirm(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = (update.message.text or "").strip().lower()
    if text == "Ğ½Ğ°Ğ·Ğ°Ğ´":
        context.user_data["q_idx"] = len(config.QUESTIONS) - 1
        return await _ask_next_question(update, context)

    if text == "Ğ´Ğ°":
        answers = context.user_data["answers"]
        answers["recommend"] = answers.get("recommend") == "Ğ”Ğ°"
        await save_review(answers)
        await update.message.reply_text("Ğ¡Ğ¿Ğ°ÑĞ¸Ğ±Ğ¾! ĞÑ‚Ğ·Ñ‹Ğ² Ğ¿Ñ€Ğ¸Ğ½ÑÑ‚ âœ…", reply_markup=ReplyKeyboardRemove())
        return ConversationHandler.END

    if text == "Ğ½ĞµÑ‚":
        await update.message.reply_text("ĞĞº, Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ÑÑÑŒ Ğ² Ğ¼ĞµĞ½Ñ. Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ:", reply_markup=MAIN_MENU)
        return ConversationHandler.END

    await update.message.reply_text("ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, Ğ½Ğ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ 'Ğ”Ğ°', 'ĞĞµÑ‚' Ğ¸Ğ»Ğ¸ 'ĞĞ°Ğ·Ğ°Ğ´'.")
    return CONFIRM

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Fallbacks
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async def _restart(update: Update, context: ContextTypes.DEFAULT_TYPE):
    context.user_data.clear()
    await cmd_start(update, context)
    return ConversationHandler.END

async def _cancel(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text("ĞĞ¿ĞµÑ€Ğ°Ñ†Ğ¸Ñ Ğ¾Ñ‚Ğ¼ĞµĞ½ĞµĞ½Ğ°.", reply_markup=ReplyKeyboardRemove())
    return ConversationHandler.END

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ConversationHandler
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
review_conv_handler = ConversationHandler(
    entry_points=[
        CommandHandler("review", entry_start_review),
        MessageHandler(filters.Regex(r"^ğŸ“ ĞÑÑ‚Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¾Ñ‚Ğ·Ñ‹Ğ²$"), entry_start_review),
    ],
    states={
        ASKING: [MessageHandler(filters.TEXT & (~filters.COMMAND), _collect_answer)],
        CONFIRM: [MessageHandler(filters.TEXT & (~filters.COMMAND), _confirm)],
    },
    fallbacks=[
        CommandHandler("cancel", _cancel),
        CommandHandler("start", _restart),
    ],
)
